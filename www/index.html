<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<!--<base href="https://openeth.com/">-->
	<title>OpenEth</title>
	<meta name="description" content="Community-driven ethical explication system.">
	<meta name="author" content="SitePoint">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>
<body>

<header>
	<nav>
		<a href="/">OpenEth</a>
		<a href="/">Featured Dilemmas</a>
		<a href="/">Play with Ethics</a>
		<a href="/">Guidance</a>
		<button onclick="login()">Log in</button>
		<button onclick="logout()">Log out</button>
	</nav>
	<div id="head_start" style="display: none;">
		<p class="one-column">OpenEth is a project designed to enable a crowd-sourced analysis of ethical
		dilemmas, to enable better decisions based upon available information, and its 
		relative likelihood.</p>
		<p><button class="button" onclick="register()">Join OpenEth</button></p>
	</div>
	<div id="head_dilemma" style="display: none;">
		<p class="one-column" data-content="name"></p>
	</div>
	<div id="head_cases" style="display: none;">
		<p class="one-column" data-content="name"></p>
	</div>
	<div id="head_edit_dilemma" style="display: none;">
		<p class="one-column">Edit dilemma</p>
	</div>
	<div id="head_edit_case" style="display: none;">
		<p class="one-column">Edit case</p>
	</div>
</header>

<main id="start" style="display: none;">
<article class="dilemmas">
	<section>
		<header>
			<h1>Featured dilemmas</h1>
		</header>
		<div class="dilemmas">
			<template data-array="dilemmas">
				<section class="dilemma button vertical" onclick="open_dilemma(this)">
					<input type="hidden" data-value="id">
					<header>
						<h1 data-content="name"></h1>
					</header>
					<p class="adjust" data-content="description"></p>
					<ul>
						<template data-array="features">
							<li data-content=""></li>
						</template>
					</ul>
					<footer>
						<span data-content="num_cases"></span>
						<span>Cases</span>
					</footer>
				</section>
			</template>
			<button class="dilemma" onclick="go_to('/dilemmas/new?edit')">
				<span class="icon">âŠ•</span>
				<span class="label">Add a dilemma</span>
			</button>
		</div>
	</section>
</article>
</main>

<main id="dilemma" style="display: none;">
	<input type="hidden" data-value="id">
	<article class="dilemma">
		<section>
			<p class="two-column" data-content="description"></p>
		</section>
		<section>
			<header>
				<h1>Actions</h1>
			</header>
			<ul>
				<template data-array="actions">
					<li data-content=""></li>
				</template>
			</ul>
		</section>
		<section>
			<header>
				<h1>Features</h1>
			</header>
			<ul>
				<template data-array="features">
					<li data-content=""></li>
				</template>
			</ul>
		</section>
		<section class="collapsable">
			<header>
				<h1>Cases</h1>
			</header>
			<div class="flex-4">
				<template data-array="cases">
					<section class="case button vertical" onclick="open_case(this)">
						<input type="hidden" data-value="id">
						<h2 data-content="name"></h2>
						<p>Author: <span data-conten="author">Homer</span></p>
						<p class="description adjust" data-content="description"></p>
						<h3>Correct Action</h3>
						<p class="action" data-content="action"></p>
					</section>
				</template>
			</div>
		</section>
		<section>
			<header>
				<h1>Key Takeaway / Duties</h1>
			</header>
			<p>It can be inferred that there are (prima facie) duties to:</p>
			<ul>
				<template data-array="duties">
					<li data-content=""></li>
				</template>
			</ul>
		</section>
		<section>
			<header>
				<h1>Rules</h1>
			</header>
			<div class="principles two-column">
				<ul class="principles">
					<template data-array="principles">
						<li class="principle">
							<p>An action is ethically preferable to another if it</p>
							<ul class="clauses">
								<template data-array="clauses">
									<li class="clause" data-content=""></li>
								</template>
							</ul>
						</li>
					</template>
				</ul>
			</div>
		</section>
	</article>
</main>

<main id="case" style="display: none;">
	<input type="hidden" data-value="id">
	<article class="dilemma">
		<section>
			<p class="two-column" data-content="description"></p>
		</section>
		<section>
			<header>
				<h1>Correct Action</h1>
			</header>
			<p data-content="action"></p>
		</section>
		<section>
			<header>
				<h1>Features</h1>
			</header>
			<table>
				<thead>
					<tr>
						<th>Feature</th>
						<template data-array="actions">
							<th data-content=""></th>
						</template>
					</tr>
				</thead>
				<tbody>
					<template data-array="features">
						<tr>
							<td data-content="feature"></td>
							<template data-array="values">
								<td data-content=""></td>
							</template>
						</tr>
					</template>
				</tbody>
			</table>
		</section>
	</article>
</main>


<main id="edit_dilemma" style="display: none;">
	<input type="hidden" data-value="id">
	<article class="dilemma">
		<section>
			<header>
				<h1>Features</h1>
			</header>
			<input type="text" class="heading" data-value="name" placeholder="Name">
		</section>
		<section>
			<header>
				<h1>Description</h1>
			</header>
			<textarea data-value="description" placeholder="Description"></textarea>
		</section>
		<section>
			<header>
				<h1>Actions</h1>
			</header>
			<template data-array="actions">
				<input type="text" data-value="">
			</template>
		</section>
		<section>
			<header>
				<h1>Features</h1>
			</header>
			<ul>
				<template data-array="features">
					<li>
						<input type="text" data-value="">
					</li>
				</template>
				<li>
					<input type="text" placeholder="Add a feature">
				</li>
			</ul>
		</section>
	</article>
</main>

<main id="edit_case" style="display: none;">
	<input type="hidden" data-value="id">
	<article class="dilemma">
		<section>
			<header>
				<h1>Name</h1>
			</header>
			<input type="text" class="heading" data-value="name" placeholder="Name">
		</section>
		<section>
			<header>
				<h1>Description</h1>
			</header>
			<textarea data-value="description" placeholder="Description"></textarea>
		</section>
		<section>
			<header>
				<h1>Correct action</h1>
			</header>
			<template data-array="actions">
				<label>
					<input type="radio" name="correct_action" data-value="">
					<span data-content=""></span>
				</label>
			</template>
		</section>
		<section>
			<header>
				<h1>Features</h1>
			</header>
			<template data-array="features">
				<div class="vertical feature_slider">
					<label>
						<input type="checkbox" data-value="feature">
						<span data-content="feature"></span>
					</label>
					<input type="range" min="-3" max="3">
				</div>
			</template>
		</section>
	</article>
</main>

<main id="not_found" style="display: none;">
	<p>Page not found!</p>
</main>


<footer>
	<p>
		Brought to you by the Dex Ethics team.
	</p>
</footer>
<script type="text/javascript" src="//cdn.auth0.com/js/lock-9.0.js"></script>
<script type="text/javascript" src="/script.js"></script>
<script type="text/javascript" src="/openeth.js"></script>
<script type="text/javascript">


function open_dilemma(node) {
	var id = node.getElementsByTagName('input')[0].value;
	go_to("/dilemmas/" + id);
}

function open_case(node) {
	var id = node.getElementsByTagName('input')[0].value;
	go_to("/cases/" + id);
}

function init_feature_sliders() {
	for(var el of document.querySelectorAll(".feature_slider")) {
		console.log(el);
	}
}


function dilemmas_add_cases_count(state)
{
	state.dilemmas.forEach(function(dilemma) {
		dilemma.num_cases = dilemma.cases.length;
	});
}

// TODO: Handle request errors.
function load_state(url, callback) {
	console.log("Loading state for " + url + "...");
	if(url.path.length == 0) {
		api.get('dilemmas')
		.select('*,cases{id}')
		.order('id', true)
		.range(0, 10)
		.then(callback);
	} else if(url.path.length == 2 && url.path[0] == 'dilemmas') {
		if(url.path[1] == 'new') {
			callback({
				id: null,
				name: "New Dilemma",
				description: "Please edit this dilemma.",
				actions: ["Action A", "Action B"],
				features: ["Feature 1"],
				cases: []
			});
		} else {
			api.get('dilemmas')
			.select('*,cases{*}')
			.eq('id', url.path[1])
			.single()
			.then(callback);
		}
	} else if(url.path.length == 2 && url.path[0] == 'cases') {
		if(url.path[1] == 'new') {
			api.get('dilemmas')
			.select('*')
			.eq('id', url.query.dilemma)
			.single()
			.then(function(dilemma) {
				callback({
					id: null,
					dilemma: dilemma,
					name: "New Case",
					description: "",
					action: undefined,
					features: [
							[null].repeat(dilemma.features.length)
						].repeat(dilemma.actions.length)
				});
			});
		} else {
			api.get('cases')
			.select('*,dilemma{*}')
			.eq('id', url.path[1])
			.single()
			.then(callback);
		}
	} else {
		callback({});
	}
}

function load_page(url, state) {
	console.log("Constructing page for " + url + "...");
	state = deep_copy_object(state);
	for(var el of document.querySelectorAll('main, header > div'))
		el.style.display = 'none';
	//try {
		if(url.path.length == 0) {
			state = { dilemmas: state };
			dilemmas_add_cases_count(state);
			join('head_start', state).style.display = '';
			join('start', state).style.display = '';
		} else if(url.path.length == 2 && url.path[0] == 'dilemmas') {
			solve_dilemma(state);
			dilemma_map_actions(state);
			if('edit' in url.query) {
				join('head_edit_dilemma', state).style.display = '';
				join('edit_dilemma', state).style.display = '';
				rescale_textareas();
			} else {
				join('head_dilemma', state).style.display = '';
				join('dilemma', state).style.display = '';
			}
		} else if(url.path.length == 2 && url.path[0] == 'cases') {
			state.actions = state.dilemma.actions;
			state.action = state.actions[state.action];
			case_map_features(state);
			if('edit' in url.query) {
				join('head_edit_case', state).style.display = '';
				join('edit_case', state).style.display = '';
				rescale_textareas();
				init_feature_sliders();
			} else {
				join('head_cases', state).style.display = '';
				join('case', state).style.display = '';
			}
		} else {
			document.getElementById('not_found').style.display = '';
		}
	//} catch(error) {
	//	// TODO: Show error page.
	//	console.error(error);
	//}
}

function go_to(url) {
	url = parse_url(url);
	console.log("Going to " + url + "...");
	load_state(url, function(state) {
		load_page(url, state);
		window.history.pushState(state, "", url);
	});
}

window.addEventListener('DOMContentLoaded', function() {
	var url = parse_url(window.document.location);
	if(window.history.state === null || true) {
		console.log("Starting on " + url + "...");
		load_state(url, function(state){
			load_page(url, state);
			window.history.replaceState(state, "", window.document.location.href);
		});
	} else {
		console.log("Using cached state...");
		load_page(url, window.history.state);
	}
});

window.addEventListener('popstate', function(event) {
	var url = parse_url(window.document.location);
	console.log("Going back to " + url + "...");
	load_page(url, event.state);
});

document.addEventListener('login', function(event) {
	console.log(event.detail);
});

</script>
</body>
</html>
